# v5.1 Angr Symbolic Execution Integration Implementation Plan

**Goal:** Integrate Angr into the `ReverseAgent` via MCP, enabling automated path solving and logic decryption.

**Context:** This is the first stage of the v5.0 "Horde" architecture, focusing on the `SymmNode` capabilities.

---

## Phase A: Core Angr Tool Implementation

### Task 1: Angr Solve Tool (`reverse_angr_solve`)

**Goal:** Create a tool that takes a binary and a target address/string, and uses Angr to find the input that reaches it.

- [ ] **Step 1: Test Case Definition**
  - Create `tests/tools/test_reverse_angr.py`.
  - Mock a simple binary analysis scenario (using a small dummy binary or mock data).
  - Verify `reverse_angr_solve` returns the correct input bytes.

- [ ] **Step 2: Tool Implementation**
  - Create `src/asas_mcp/tools/reverse_angr.py`.
  - Implement `reverse_angr_solve(binary_path: str, find_addr: str, avoid_addrs: List[str] = [])`.
  - Use `angr.Project` and `SimulationManager.explore`.

- [ ] **Step 3: Validation**
  - `PYTHONPATH=src pytest tests/tools/test_reverse_angr.py`

### Task 2: Constraint Solving Helper (`reverse_angr_eval`)

**Goal:** Provide a way for the Agent to evaluate expressions or find valid inputs for specific functions.

- [ ] **Step 1: Implement `reverse_angr_eval`**
  - Support passing symbolic variables and constraints as a JSON-defined schema.
  - Return potential solutions for the symbolic variables.

---

## Phase B: Agent Integration & SOP Upgrade

### Task 3: Equipping the ReverseAgent

- [ ] **Step 1: Tool Binding**
  - Modify `src/asas_agent/agents/reverse.py` to import and register `reverse_angr_solve`.

- [ ] **Step 2: Prompt Engineering**
  - Update `ReverseAgent` system prompt to include the "Guided Hunting" strategy:
    - "If you find a hard-coded check or a specific 'Success' branch in IDA, use `reverse_angr_solve` to generate the required input."

### Task 4: Documentation (RAG Support)

- [ ] **Step 1: Update Knowledge Base**
  - Add common Angr usage patterns to the internal knowledge base to help the Agent understand when to use symbolic execution vs. static analysis.

---

## Phase C: E2E Verification

### Task 5: The "CrackMe" Challenge Test

- [ ] **Step 1: E2E Test Script**
  - Create `tests/agent/test_angr_e2e_v5.py`.
  - Simulate a scenario:
        1. IDA Pro finds a "Correct!" string at `0x401234`.
        2. ReverseAgent decides to use Angr to find the input reaching `0x401234`.
        3. Angr returns the flag-generating input.

---

## Tech Stack & Dependencies

- **Angr**: `pip install angr`
- **LangGraph**: (Existing) for flow management.
- **Python**: 3.11+
