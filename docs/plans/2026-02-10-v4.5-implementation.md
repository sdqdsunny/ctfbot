# v4.5 IDA Pro Integration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Integrate IDA Pro (Headless) into the ReverseAgent via MCP, enabling automated analysis.

**Architecture:** Python-based `IdaClient` connects to `ida-pro-mcp` via SSE. Tools are wrapped in `asas_mcp` and exposed to `ReverseAgent`.

**Tech Stack:** Python 3.11+, `httpx` (for SSE), `ida-pro-mcp` (server), `langchain`.

**Note:** This plan uses **Mocks** for testing, allowing implementation even if the IDA server is not currently running.

---

## Phase A: IDA Client Implementation

### Task 1: Async SSE Client Skeleton

**Files:**

- Create: `src/asas_mcp/clients/ida_client.py`
- Test: `tests/infrastructure/test_ida_client.py`

**Step 1: Write failing test for client connection**

- Mock `httpx.AsyncClient` to simulate an SSE stream connection.
- Verify `IdaClient.connect()` initiates the stream.

**Step 2: Implement IdaClient class**

- Use `httpx` to connect to `http://localhost:8745/sse`.
- Implement background listener loop.

**Step 3: Run test**
`pytest tests/infrastructure/test_ida_client.py`

**Step 4: Commit**
`git commit -m "feat(ida): implement basic async sse client"`

### Task 2: Command Execution Logic

**Files:**

- Modify: `src/asas_mcp/clients/ida_client.py`
- Modify: `tests/infrastructure/test_ida_client.py`

**Step 1: Write failing test for execute_tool**

- Mock the SSE stream to return a JSON-RPC result when a tool is called.
- Call `client.execute_tool("decompile", {"addr": "0x1234"})`.
- Assert result matches mock.

**Step 2: Implement execute_tool**

- Send POST request to `/mcp` endpoint (or similar, depending on ida-pro-mcp protocol).
- *Correction*: `ida-pro-mcp` typically uses JSON-RPC over stdio or HTTP. We will assume HTTP Post for commands if SSE is for events, or check specific protocol. *Assumption: MCP over HTTP usually involves POST for JSON-RPC requests.*

**Step 3: Run test**
`pytest tests/infrastructure/test_ida_client.py`

**Step 4: Commit**
`git commit -m "feat(ida): add tool execution logic"`

---

## Phase B: Tool Wrappers & Agent Upgrade

### Task 3: IDA Tool Definitions

**Files:**

- Create: `src/asas_mcp/tools/ida_tools.py`
- Test: `tests/tools/test_ida_tools.py`

**Step 1: Define Tool Functions**

- Implement `ida_decompile(addr: str)`, `ida_xrefs(addr: str)`, `ida_run_script(script: str)`.
- Each function should instantiate `IdaClient` (singleton) and call `execute_tool`.

**Step 2: Test Wrappers**

- Mock `IdaClient.execute_tool`.
- Verify `ida_decompile` calls client with correct arguments.

**Step 3: Commit**
`git commit -m "feat(ida): implement tool wrappers"`

### Task 4: ReverseAgent Upgrade

**Files:**

- Modify: `src/asas_agent/agents/reverse.py`

**Step 1: Update System Prompt**

- Add instructions: "优先使用 `ida_` 开头的工具进行分析。"
- Add workflow: "Startup -> ida_auto_analyze() -> check results".

**Step 2: Bind New Tools**

- Add `ida_tools` to the agent's toolset.

**Step 3: Commit**
`git commit -m "feat(agent): equip ReverseAgent with IDA tools"`

---

## Phase C: Infrastructure Scripts

### Task 5: Server Launcher

**Files:**

- Create: `scripts/start_ida_server.sh`
- Create: `scripts/verify_ida_env.py`

**Step 1: Create Launch Script**

- Command: `uv run idalib-mcp --host 127.0.0.1 --port 8745 "$1"`

**Step 2: Create Verification Script**

- Simple Python script to check if port 8745 is open.

**Step 3: Commit**
`git commit -m "infra(ida): add server launch scripts"`

---

## Execution Handoff

**"Plan complete and saved to `docs/plans/2026-02-10-v4.5-implementation.md`.**

**To execute this plan later:**

1. Open a new session.
2. Run: `/execute-plan` (and select this file).
3. Ensure `idalib` is installed to run the actual server, OR just run the tests to verify the client code."
