# CTF 自动解题智能体系统 (CTF-ASAS) 项目需求说明书

| 项目 | 说明 |
| :--- | :--- |
| **文档版本** | 1.7 (加入 ZeroClaw GUI 协同增强) |
| **文档状态** | 终稿 (Final) |
| **主要负责人** | 郭曙光 / AI 助手 |
| **最后更新日期** | 2026 年 2 月 |

---

## 1. 项目概述

### 1.1 项目背景

CTF 竞赛高度依赖人工，存在人才稀缺、重复性劳动多、学习曲线陡峭等痛点。本项目旨在构建一个基于 LLM 多智能体协作的自动化系统，模拟专家思维，打通从“题目获取”到“Flag 提交”的全流程。

### 1.2 核心设计目标

* **标准化：** 采用 **MCP 协议** 实现工具链与大脑的解耦。
* **自动化：** 实现 30%-70% 题目的全流程自动闭环（含自动提交）。
* **安全性：** 利用 **gVisor** 构建工业级安全沙箱。
* **全能性：** 覆盖 Web、Pwn、Crypto、Reverse、Misc 五大核心题型。
* **深度逻辑：** 引入递归任务树、结构化事实仓库与多 Agent 编排机制。

---

## 2. 系统架构设计

### 2.1 四层联动逻辑架构

系统由以下四个物理与逻辑层组成，采用 **混合 MCP Server** 架构：

#### 1. 决策层 (Thinking Layer)

* **基于 LangGraph 的状态机**：负责任务生命周期管理。
* **递归任务拆解**：将大目标拆分为子任务树（Task Tree）。
* **混合题型识别引擎**：
  * **一级粗筛**：基于规则引擎（文件后缀、端口特征）快速分类。
  * **二级精判**：LLM 语义分析兜底（由 Agent 阅读题目描述与附件元数据）。
  * **人工干预**：支持用户强行指定题型。
* **跨工具编排**：Agent 统一负责跨领域工具的调用顺序（如 Reverse -> Crypto），通过事实仓库共享上下文。

#### 2. 能力层 (MCP Server Layer)

采用 **混合模式 (Hybrid Mode)** 管理工具服务：

* **ASAS-Core-MCP (常驻)**：
  * 托管轻量级工具：Web 扫描、基础 Pwn 分析、基础 Crypto (编码解码)、Misc (隐写/流量)。
  * 职责：提供高频、低延迟的工具调用。
* **Specialized-MCPs (按需/混合)**：
  * **Heavy Tools**：Ghidra Server (逆向)、SageMath Server (高数求解)、Angr Server (符号执行)。
  * **资源策略**：采用 **混合策略**，高频工具保有少量热备实例，低频工具按需冷启动。

#### 3. 隔离执行层 (Execution Layer)

* **加固沙箱**：基于 **gVisor (runsc)** 的 Docker 容器。
* **环境同步引擎**：动态注入平台环境变量（Target IP/Port）。

#### 4. 数据与记忆层 (Memory Layer)

* **结构化事实仓库 (Structured Fact Store)**：
  * 存储带溯源的原子事实，结构示例：`{id, type, value, source, confidence, timestamp}`。
  * 支持事实间的关联（Relations），便于生成 Writeup。
* **向量库**：存储 Writeups (WP) 与代码片段 (Snippets)。

---

## 3. 功能需求 (详细清单)

### 3.1 任务编排与逻辑规划

* **F3.1.1 递归任务树：** 动态维护任务看板，支持子任务生成与状态回滚。
* **F3.1.2 结构化事实管理：** 所有关键发现（关键字符串、漏洞点、密钥）必须存入事实仓库，禁止仅在对话历史中流转。
* **F3.1.3 输出智能蒸馏：** 针对长输出工具，由蒸馏器提取核心特征仅反馈精华给 LLM。

### 3.2 平台闭环与环境同步

* **F3.2.1 平台自动适配：** 对接 BUUCTF/CTFd API，一键启动环境。
* **F3.2.2 环境变量动态注入：** 自动注入 `TARGET_IP` / `TARGET_PORT`。
* **F3.2.3 闭环提交：** 自动提交 Flag 并处理反馈。

### 3.3 扩展题型能力模块 (v1.6 新增)

#### F3.3.1 Crypto (密码学) - 全覆盖

* **基础能力**：自动识别与解码 (Base64/Hex/..)、经典密码破解 (凯撒/维吉尼亚/..)。
* **现代密码**：
  * **RSA**：公模攻击、低指数广播攻击、Coppersmith 攻击、Wiener 攻击。
  * **AES/DES**：Padding Oracle、ECB 模式分析、密钥恢复。
  * **ECC**：参数恢复、各种曲线攻击。
  * **Lattice**：基于 LLL/CVP 的格密码求解。
* **自动化求解**：集成 **SageMath** / **Z3** 进行符号计算与方程组求解。

#### F3.3.2 Reverse (逆向工程) - 全覆盖

* **静态分析**：
  * **反编译**：集成 **Ghidra** 提供伪代码分析。
  * **特征提取**：字符串提取、函数符号恢复、控制流图 (CFG) 分析。
* **动态分析**：
  * **调试**：基于 GDB/LLDB 的自动化断点调试与寄存器监控。
  * **模拟执行**：集成 Unicorn/Qiling 进行片段模拟。
  * **符号执行**：集成 **Angr** 进行路径约束求解。
* **多平台支持**：x86/x64, ARM, MIPS, PE/ELF, Android APK。

#### F3.3.3 Misc (杂项) - 核心覆盖

* **隐写分析 (Steganography)**：
  * **图像**：LSB、通道分析、Stegsolve 功能复刻。
  * **音频**：频谱分析、波形分析。
  * **压缩包**：伪加密识别、CRC 爆破、嵌套解压。
* **流量与取证**：
  * **PCAP 分析**：协议还原、流重组、敏感数据提取。
  * **文件修复**：文件头/尾修复、文件分离 (Binwalk)。

### 3.4 人机协同 (HITL) 与 WP 生成

* **F3.4.1 动态审批流：** 关键操作（如高危 Exploit 发送）需人工确认。
* **F3.4.2 终端接管：** 支持一键 Xterm.js 介入调试。
* **F3.4.3 GUI 靶机协同交互 (基于 ZeroClaw)：** 集成 ZeroClaw 智能体运行时，实现对 VMware Fusion 上运行的 `kali` 和 `pentest-windows` 虚拟机的 Browser-based VNC (NoVNC) 可视化控制。突破纯 CLI 限制，支持选手与 Agent 的双向 GUI 桌面协同。
* **F3.4.4 自动化 WP 溯源：** 基于“任务树 + 事实仓库（带溯源）”自动生成包含解题路径、工具输出和推理逻辑的 Markdown 报告。

---

## 4. 非功能需求

### 4.1 安全性 (Security)

* **强沙箱**：全系容器强制 gVisor 运行。
* **网络限制**：仅允许访问题目 IP 和必要的公共资源源，禁止内网横向。

### 4.2 性能与资源

* **响应速度**：核心工具调用 < 2s。
* **重型资源管理**：Ghidra/SageMath 等重型 Server 提供按需冷启动支持（允许 5-10s 启动延迟），高频场景可配置热备池。

---

## 5. 技术栈选择

| 组件 | 技术方案 |
| :--- | :--- |
| **大脑 (LLM)** | Claude 3.5 Sonnet / GPT-4o / DeepSeek-V3 |
| **Agent 框架** | **LangGraph** |
| **通信协议** | **Model Context Protocol (MCP)** |
| **核心后端** | Python 3.10+ / FastAPI |
| **沙箱环境** | Docker + **gVisor** |
| **专用计算引擎** | **Ghidra** (逆向 headless), **SageMath** (数学), **Angr** (符号执行) |
| **数据库** | PostgreSQL (事实仓库/状态) + Weaviate (向量库) |
| **前端** | React + Ant Design + Xterm.js |

---

## 6. 风险评估与对策

* **风险：** 复杂题型（如高阶堆利用）Token 消耗巨大。
  * *对策：* 设置单题 Token 熔断阈值；对于复杂的堆布局计算，优先调用专门的 Python Heap 分析脚本而非纯 LLM 推理。
* **风险：** 自动化工具误报导致死胡同。
  * *对策：* 引入“回溯机制”，当一条路径走不通时，自动回滚任务树状态，尝试次优解。

---

## 7. 下一步计划 (Milestones)

1. **[1-2周]** ASAS-Core-MCP 开发，打通基础 Web/Pwn/Misc 流程。
2. **[3-4周]** 部署 Ghidra/SageMath 服务容器，实现 MCP 协议封装与混合调度。
3. **[5-6周]** 实现 LangGraph 任务编排与结构化事实仓库。
4. **[7-8周]** 全闭环实战测试，覆盖 5 大题型 Top 30 经典题目。
